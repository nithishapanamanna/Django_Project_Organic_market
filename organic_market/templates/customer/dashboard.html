{%extends 'customer/customer_base.html' %}
{% load static %}
{% block content %}
<style>
  .product-card {
    border: 0;
    border-radius: 14px;
    overflow: hidden;
  }
  .product-card img {
    height: 150px;
    width: 100%;
    object-fit: cover;
  }
  .product-card .card-body {
    padding: 0.75rem;
    min-height: 175px;
  }
  .product-title {
    font-size: 0.98rem;
    margin-bottom: 0.35rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 2.6em;
  }
  .meta { font-size: 0.8rem; }
  .badge-stock { font-size: 0.72rem; }
</style>

<div class="container mt-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
    <div>
      <h3 class="text-success fw-bold hero-title">Customer Dashboard</h3>
      <div class="text-muted meta">Fresh picks curated just for you</div>
    </div>
    <h4 class="mt-2 mt-md-0">ðŸ‘‹ Welcome, {{ request.user.username }}</h4>
  </div>

  <form method="get" class="row g-2 align-items-end mb-3">
    {% if query %}
      <input type="hidden" name="q" value="{{ query }}">
    {% endif %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <label class="form-label fw-semibold">Category</label>
      <select name="category" class="form-select">
        <option value="">All Categories</option>
        {% for value, label in categories %}
          <option value="{{ value }}" {% if value == selected_category %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-end">
      <button class="btn btn-success btn-sm px-3">Filter</button>
    </div>
  </form>

  <div class="row g-3">
    {% for product in products %}
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card product-card shadow-sm h-100">
          {% if product.image %}
            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
          {% else %}
            <img src="https://via.placeholder.com/300x200?text=No+Image" class="card-img-top" alt="No image">
          {% endif %}

          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <div class="product-title fw-semibold">{{ product.name }}</div>
              <div class="text-success fw-bold price">â‚¹ {{ product.price }}</div>
            </div>

            <div class="text-muted meta mb-1">Farmer: {{ product.farmer.user.username }}</div>
            <div class="meta mb-1">
              {% if product.review_count %}
                <span class="badge bg-warning text-dark">? {{ product.avg_rating|floatformat:1 }}</span>
                <span class="text-muted">({{ product.review_count }} reviews)</span>
              {% else %}
                <span class="text-muted">No reviews yet</span>
              {% endif %}
            </div>
            <div class="text-muted meta mb-2">
              Harvest: {{ product.harvest_date|default:"N/A" }} ??
              Expiry: {{ product.expiry_date|default:"N/A" }}
            </div>

            <div class="d-flex align-items-center justify-content-between mt-auto">
              {% if product.stock > 0 %}
                <span class="badge bg-success badge-stock">In Stock ({{ product.stock }})</span>
              {% else %}
                <span class="badge bg-danger badge-stock">Out of Stock</span>
              {% endif %}

              <div class="d-flex align-items-center gap-2">
                <a href="{% url 'product_detail' product.id %}" class="btn btn-outline-success btn-sm">Reviews</a>
                <form method="post" action="{% url 'add_to_cart' product.id %}">
                  {% csrf_token %}
                  <button class="btn btn-success btn-sm" {% if product.stock == 0 %}disabled{% endif %}>Add to Cart</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <p class="text-center text-muted">No products available.</p>
      </div>
    {% endfor %}
  </div>

  {% if page_obj.paginator.num_pages > 1 %}
    <nav class="mt-4" aria-label="Products pagination">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if query %}&q={{ query }}{% endif %}">Previous</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if query %}&q={{ query }}{% endif %}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
{% comment %} <footer class="bg-light text-center py-3 mt-5">
  <small>? 2026 Organic Market | Fresh from Farmers</small>
</footer> {% endcomment %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
