{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}">
</head>
<body class="bg-light d-flex flex-column min-vh-100">
<nav class="navbar navbar-success bg-dark px-4 d-flex justify-content-between">
    
    <span class="navbar-brand fw-bold text-white"> 🔐 Admin Panel </span>
    <div class="d-flex align-items-center gap-4">

        <!-- 🔔Farmer Notification -->
        <a href="{% url 'verify_farmers' %}" class="text-white text-decoration-none">
            👨‍🌾 Farmers
            {% if pending_farmer_count > 0 %}
                <span class="badge bg-danger">
                    {{ pending_farmer_count }}
                </span>
            {% endif %}
        </a>

        <!-- Product Notification -->
        <a href="{% url 'approve_products' %}" class="text-white text-decoration-none">
            📦 Products
            {% if pending_product_count > 0 %}
                <span class="badge bg-warning text-dark">
                    {{ pending_product_count }}
                </span>
            {% endif %}
        </a>

        <!-- Order Notification -->
        <a href="{% url 'manage_orders' %}" class="text-white text-decoration-none">
            🛒 Orders
            {% if pending_order_count > 0 %}
                <span class="badge bg-info text-dark">
                    {{ pending_order_count }}
                </span>
            {% endif %}
        </a>

        <!-- Payment Notification -->
        <a href="{% url 'manage_payments' %}" class="text-white text-decoration-none">
            💳 Payments
            {% if pending_payment_count > 0 %}
                <span class="badge bg-danger">
                    {{ pending_payment_count }}
                </span>
            {% endif %}
        </a>

        <!-- Admin User -->
        <span class="text-white">
            👋 Welcome, {{ request.user.username }}
        </span>

        <a href="{% url 'logout' %}" class="btn btn-sm btn-outline-light">
            Logout
        </a>

    </div>

</nav>


<main class="flex-grow-1">
<div class="container-fluid p-4">

    <h3 class="mb-4 fw-bold">📊 Admin Dashboard</h3>

    <!-- STAT CARDS -->
    <div class="row g-4 mb-4">

        <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
                <h5>👨‍🌾 Farmers</h5>
                <p>Verify & manage</p>
                <h6>Total Farmers</h6>
                <h2 class="text-success">{{ total_farmers }}</h2>
                <small class="text-muted">Verified: {{ verified_farmers }}</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
                <h5>📦 Products</h5>
                <p>Approve / Reject</p>
                <h6>Total Products</h6>
                <h2 class="text-primary">{{ total_products }}</h2>
                <small class="text-muted">Approved: {{ approved_products }}</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
                <h5>🛒 Orders</h5>
                <p>Track orders</p>
                <h6>Total Orders</h6>
                <h2 class="text-warning">{{ total_orders }}</h2>
                <small class="text-muted">Tracked: {{ approved_orders }}</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
                <h5>💳 Payments</h5>
                <p>Transactions</p>
                <h6>Total Revenue</h6>
                <h2 class="text-danger">₹ {{ revenue }}</h2>
            </div>
        </div>

    </div>

    <!-- CHARTS -->
    <div class="row g-6">

        <!-- Order Status Chart -->
        <div class="col-md-6">
            <div class="card shadow-sm p-3 chart-card">
                <h6 class="fw-bold mb-3">Order Status Overview</h6>
                <canvas id="orderStatusChart" class="chart-canvas"></canvas>
                <div class="chart-legend-note">Legend shows order status</div>
            </div>
        </div>

        <!-- Revenue Charts -->
        <div class="col-md-6">
            <div class="card shadow-sm p-3 chart-card">
                <h6 class="fw-bold mb-3">Daily Revenue (Last 7 Days)</h6>
                <canvas id="dailyRevenueChart" class="chart-canvas"></canvas>
            </div>
            <div class="card shadow-sm p-3 chart-card mt-3">
                <h6 class="fw-bold mb-3">Monthly Revenue (Last 12 Months)</h6>
                <canvas id="monthlyRevenueChart" class="chart-canvas"></canvas>
            </div>
        </div>

    </div>

</div>
</main>

<script>
    // ORDER STATUS PIE CHART
    const statusCtx = document.getElementById('orderStatusChart');
    const statusCounts = [
        {{ status_data.pending|default:0 }},
        {{ status_data.shipped|default:0 }},
        {{ status_data.delivered|default:0 }},
        {{ status_data.cancelled|default:0 }}
    ];
    const statusTotal = {{ status_total|default:0 }};
    const displayCounts = statusTotal > 0 ? statusCounts : [0, 0, 0, 0];
    const pieData = statusTotal > 0 ? statusCounts : [1, 1, 1, 1];
    new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: ['Pending', 'Shipped', 'Delivered', 'Cancelled'],
            datasets: [{
                data: pieData,
                backgroundColor: ['#ffc107', '#0dcaf0', '#198754', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 14,
                        boxHeight: 14,
                        padding: 12
                    }
                },
                datalabels: {
                    color: '#212529',
                    font: {
                        weight: '600',
                        size: 11
                    },
                    formatter: (value, context) => {
                        if (statusTotal === 0) {
                            return '0 (0%)';
                        }
                        const displayValue = displayCounts[context.dataIndex] || 0;
                        const percent = Math.round((displayValue / statusTotal) * 100);
                        return `${displayValue} (${percent}%)`;
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            if (statusTotal === 0) {
                                return `${label}: 0 (0%)`;
                            }
                            const value = displayCounts[context.dataIndex] || 0;
                            const percent = Math.round((value / statusTotal) * 100);
                            return `${label}: ${value} (${percent}%)`;
                        }
                    }
                }
            },
            layout: {
                padding: { top: 6, bottom: 6 }
            }
        },
        plugins: [ChartDataLabels]
    });

    // DAILY REVENUE LINE CHART
    const dailyRevenueCtx = document.getElementById('dailyRevenueChart');
    new Chart(dailyRevenueCtx, {
        type: 'line',
        data: {
            labels: {{ daily_labels|safe }},
            datasets: [{
                label: 'Daily Revenue',
                data: {{ daily_values|safe }},
                borderColor: '#198754',
                fill: false,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // MONTHLY REVENUE LINE CHART
    const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart');
    new Chart(monthlyRevenueCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
                label: 'Monthly Revenue',
                data: {{ monthly_values|safe }},
                borderColor: '#0d6efd',
                fill: false,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
</script>

</body>
</html>
